<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="lib/bootstrap.min.css">
    <script src="lib/jquery-2.1.4.js"></script>
    <script src="lib/knockout-3.3.0.debug.js"></script>
    <script src="lib/knockout.mapping-debug.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="shared.js"></script>
    <script>
    var socket = io();
    var vm;
    socket.on('state', function (data) {
        if (!vm) {
            vm = ko.mapping.fromJS(data);
            ko.applyBindings(vm);
        } else {
            ko.mapping.fromJS(data, vm);
        }
        $('.activity').scrollTop(10000);
        console.log(data);
    });
    var exchangeOptions = ko.observableArray();
    var exchangeKeep = ko.observable(0);
    socket.on('exchange-options', function (cards) {
        var options = cards;
        var keep = 0;
        var influences = ourInfluence();
        for (var i = 0; i < influences.length; i++) {
            var inf = influences[i];
            if (!inf.revealed()) {
                options.push(inf.role);
                keep++;
            }
        }
        exchangeOptions(options);
        exchangeKeep(keep);
    });
    socket.on('error', function (data) {
        alert(data);
    });
    socket.on('game-error', function (data) {
        alert(data);
    });

    function weAreInState(stateName) {
        return vm.state.name() == stateName && vm.state.playerIdx() == vm.playerIdx();
    }
    function theyAreInState(stateName) {
        return vm.state.name() == stateName && vm.state.playerIdx() != vm.playerIdx();
    }
    function currentPlayerName() {
        if (vm.state.playerIdx() != null) {
            var player = vm.players()[vm.state.playerIdx()];
            if (player) {
                return player.name();
            }
        }
        return '';
    }
    function targetPlayerName() {
        if (vm.state.target() != null) {
            var player = vm.players()[vm.state.target()];
            if (player) {
                return player.name();
            }
        }
        return '';
    }
    function canPlayAction(actionName) {
        var action = actions[actionName];
        var player = ourPlayer();
        if (!player) {
            return false;
        }
        if (player.cash() >= 10 && actionName != 'coup') {
            return false;
        } else {
            return player.cash() >= action.cost;
        }
    }
    function playAction(actionName) {
        if (weAreInState('start-of-turn')) {
            var action = actions[actionName];
            var target;
            if (action.targetted) {
                target = (vm.state.playerIdx() + 1) % vm.numPlayers();
            }
            command('play-action', {
                action: actionName,
                target: target
            });
        }
    }
    function command(command, options) {
        var data = $.extend({
            command: command,
            stateId: vm.stateId()
        }, options);
        socket.emit('command', data);
    }
    function weCanBlock() {
        if (vm.state.name() != 'action-response') {
            return false;
        }
        var action = actions[vm.state.action()];
        if (!action) {
            return false;
        }
        if (!action.blockedBy) {
            // ACtion cannot be blocked.
            return false;
        }
        if (!action.targetted) {
            // Untargetted actions foreign aid) can be blocked by anyone.
            return true;
        }
        return vm.state.target() == vm.playerIdx();
    }
    function blockingRoles() {
        var action = actions[vm.state.action()];
        if (!action) {
            return [];
        }
        return action.blockedBy || [];
    }
    function weCanChallenge() {
        var action = actions[vm.state.action()];
        if (!action) {
            return false;
        }
        if (vm.state.name() == 'action-response') {
            // Only role-based actions can be challenged.
            return !!action.role;
        } else if (vm.state.name() == 'block-response') {
            return true;
        } else {
            return false;
        }
    }
    function block(role) {
        command('block', {
            role: role
        });
    }
    function challenge() {
        command('challenge');
    }
    function allow() {
        command('allow');
    }
    function weAreTargetted(stateName) {
        return vm.state.name() == stateName && vm.state.target() == vm.playerIdx();
    }
    function theyAreTargetted(stateName) {
        return vm.state.name() == stateName && vm.state.target() != vm.playerIdx();
    }
    function ourPlayer() {
        return vm.players()[vm.playerIdx()];
    }
    function ourInfluence() {
        var player = ourPlayer();
        return player && player.influence();
    }
    function reveal(influence) {
        command('reveal', {
            role: influence.role()
        });
    }
    function exchange() {
        var checked = $('input:checked');
        var roles = [];
        checked.each(function (index, el) {
            roles.push($(el).data('role'));
        });
        if (roles.length == exchangeKeep()) {
            command('exchange', {
                roles: roles
            });
        } else {
            alert('must choose ' + exchangeKeep() + ' roles');
        }
    }
    function displayHistory(hist) {
        var text = '';
        if (hist.playerIdx() == vm.playerIdx()) {
            text = 'You';
        } else {
            text = vm.players()[hist.playerIdx()].name();
        }
        text += ' ' + hist.message();
        var target = hist.target && hist.target();
        if (target == vm.playerIdx()) {
            text += ' you';
        } else if (target != null) {
            text += ' ' + vm.players()[target].name();
        }
        return text;
    }
    $(window).on('resize', function () {
        $('.activity').height($(window).height() - 40);
        $('.activity').scrollTop(10000);
    });
    $(function () {
        $('.activity').height($(window).height() - 40);
    });
    </script>
    <style>
    body {
        padding-top: 15px;
    }
    div.activity {
        overflow-y: scroll;
    }
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <!-- Players -->
            <div class="col-xs-4">
                <ul class="list-group" data-bind="foreach: players">
                    <li class="list-group-item">
                        <div class="row">
                            <div class="col-xs-7">
                                <span data-bind="text: name"></span>
                                <span class="badge" data-bind="text: '$' + cash()"></span>
                            </div>
                            <div class="col-xs-5">
                                <!-- ko foreach: influence -->
                                    <span class="label label-default" data-bind="text: role, css: { 'label-success': !revealed(), 'label-default': revealed() }"></span>
                                <!-- /ko -->
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
            <!-- Activity -->
            <div class="col-xs-8 activity">
                <ul class="list-group">
                    <!-- ko foreach: history -->
                        <li class="list-group-item" data-bind="text: displayHistory($data)"></li>
                    <!-- /ko -->
                    <li class="list-group-item">
                        <div data-bind="visible: state.name() == 'waiting-for-players'">Waiting for players</div>
                        <div data-bind="visible: weAreInState('start-of-turn')">
                            Your turn:
                            <!-- ko foreach: Object.keys(actions).sort() -->
                            <button class="btn btn-default" data-bind="text: $data, enable: canPlayAction($data), click: playAction"></button>
                            <!-- /ko -->
                        </div>
                        <div data-bind="visible: theyAreInState('start-of-turn')">
                            Waiting for <span data-bind="text: currentPlayerName()"></span> to play
                        </div>
                        <div data-bind="visible: theyAreInState('exchange')">
                            Waiting for <span data-bind="text: currentPlayerName()"></span> to exchange roles
                        </div>
                        <div data-bind="visible: weAreInState('exchange')">
                            Choose <span data-bind="text: exchangeKeep"></span> roles to keep:<br/>
                            <!-- ko foreach: exchangeOptions -->
                                <span data-bind="text: $data"></span>
                                <input type="checkbox" data-bind="attr: { 'data-role': $data }"></input>
                                <br/>
                            <!-- /ko -->
                            <button class="btn btn-default" data-bind="click: exchange">Exchange</button>
                        </div>
                        <div data-bind="visible: weAreInState('action-response')">
                            Waiting for blocks/challenges
                        </div>
                        <div data-bind="visible: theyAreInState('action-response')">
                            <!-- ko if: weCanBlock() -->
                                <!-- ko foreach: blockingRoles() -->
                                    <button class="btn btn-default" data-bind="click: block, text: 'Block with ' + $data"></button>
                                <!-- /ko -->
                            <!-- /ko -->
                            <button class="btn btn-default" data-bind="click: challenge, visible: weCanChallenge()">Challenge</button>
                            <button class="btn btn-default" data-bind="click: allow">Allow</button>
                        </div>
                        <div data-bind="visible: theyAreTargetted('block-response')">
                            <button class="btn btn-default" data-bind="click: challenge, visible: weCanChallenge()">Challenge</button>
                            <button class="btn btn-default" data-bind="click: allow">Allow</button>
                        </div>
                        <div data-bind="visible: weAreTargetted('block-response')">
                            Waiting for challenges
                        </div>
                        <div data-bind="visible: weAreInState('game-won')">
                            You have won!
                        </div>
                        <div data-bind="visible: theyAreInState('game-won')">
                            <span data-bind="text: currentPlayerName()"></span> has won!
                        </div>
                        <div data-bind="visible: weAreTargetted('reveal-influence')">
                            Must reveal an influence
                            <!-- ko foreach: ourInfluence() -->
                            <button class="btn btn-default" data-bind="text: role, visible: !revealed(), click: reveal"></button>
                            <!-- /ko -->
                        </div>
                        <div data-bind="visible: theyAreTargetted('reveal-influence')">
                            Waiting for <span data-bind="text: currentPlayerName()"></span> to reveal an influence
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</body>
</html>
