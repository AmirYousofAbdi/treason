<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.3.0/knockout-debug.js"></script>
    <script src="lib/knockout.mapping-debug.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="shared.js"></script>
    <script>
    var socket = io();
    var vm;
    socket.on('state', function (data) {
        if (!vm) {
            vm = ko.mapping.fromJS(data);
            ko.applyBindings(vm);
        } else {
            ko.mapping.fromJS(data, vm);
        }
        console.log(data);
    });
    socket.on('error', function (data) {
        alert(data);
    });

    function weAreInState(stateName) {
        return vm.state.name() == stateName && vm.state.playerIdx() == vm.playerIdx();
    }
    function theyAreInState(stateName) {
        return vm.state.name() == stateName && vm.state.playerIdx() != vm.playerIdx();
    }
    function currentPlayerName() {
        if (vm.state.playerIdx() == null) {
            return '';
        } else {
            return vm.players()[vm.state.playerIdx()].name();
        }
    }
    function canPlayAction(actionName) {
        var action = actions[actionName];
        var cash = vm.players()[vm.playerIdx()].cash();
        return cash >= action.cost;
    }
    function playAction(actionName) {
        if (weAreInState('start-of-turn')) {
            var action = actions[actionName];
            var target;
            if (action.targetted) {
                target = (vm.state.playerIdx() + 1) % vm.numPlayers();
            }
            socket.emit('command', {
                command: 'play-action',
                action: actionName,
                target: target
            });
        }
    }
    function weCanBlock() {
        if (vm.state.name() != 'block-challenge') {
            return false;
        }
        var action = actions[vm.state.action()];
        if (!action) {
            console.log('action not found');
            return false;
        }
        if (!action.blockedBy) {
            // ACtion cannot be blocked.
            return false;
        }
        if (!action.targetted) {
            // Untargetted actions foreign aid) can be blocked by anyone.
            return true;
        }
        return vm.state.target() == vm.playerIdx();
    }
    function block() {
        socket.emit('command', {
            command: 'block',
            stateId: vm.stateId()
        });
    }
    function challenge() {
        socket.emit('command', {
            command: 'challenge',
            stateId: vm.stateId()
        });
    }
    function weRevealInfluence() {
        return vm.state.name() == 'reveal-influence' && vm.state.target() == vm.playerIdx();
    }
    </script>
    <style>
    body {
        padding-top: 15px;
    }
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <!-- Players -->
            <div class="col-xs-4">
                <ul class="list-group" data-bind="foreach: players">
                    <li class="list-group-item">
                        <div class="row">
                            <div class="col-xs-7">
                                <span data-bind="text: name"></span>
                                <span class="badge" data-bind="text: '$' + cash()"></span>
                            </div>
                            <div class="col-xs-5">
                                <!-- ko foreach: influence -->
                                    <span class="label label-default" data-bind="text: role"></span>
                                <!-- /ko -->
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
            <!-- Activity -->
            <div class="col-xs-8">
                <div data-bind="visible: state.name() == 'waiting-for-players'">Waiting for players</div>
                <div data-bind="visible: weAreInState('start-of-turn')">
                    Your turn:
                    <!-- ko foreach: Object.keys(actions).sort() -->
                    <button class="btn btn-default" data-bind="text: $data, enable: canPlayAction($data), click: playAction"></button>
                    <!-- /ko -->
                </div>
                <div data-bind="visible: theyAreInState('start-of-turn')">
                    Waiting for <span data-bind="text: currentPlayerName()"></span> to play
                </div>
                <div data-bind="visible: weAreInState('block-challenge')">
                    Waiting for blocks/challenges
                </div>
                <div data-bind="visible: theyAreInState('block-challenge')">
                    <span data-bind="text: currentPlayerName()"></span> is attempting to
                    <span data-bind="text: state.action"></span>
                    <button data-bind="click: block, visible: weCanBlock()">Block</button>
                    <button data-bind="click: challenge">Challenge</button>
                </div>
                <div data-bind="visible: weAreInState('game-won')">
                    You have won!
                </div>
                <div data-bind="visible: theyAreInState('game-won')">
                    <span data-bind="text: currentPlayerName()"></span> has won!
                </div>
                <div data-bind="visible: weRevealInfluence()">
                    Must reveal an influence.
                    (todo: reason)
                </div>
            </div>
        </div>
    </div>
</body>
</html>
